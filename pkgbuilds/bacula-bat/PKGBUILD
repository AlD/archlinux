# Contributor: Daniel Albers <daniel@lbe.rs>

pkgbase=bacula
pkgname=('bat'
'bacula-console'
'bacula-fd'
'bacula-common'
)
pkgver=5.2.13
pkgrel=4
arch=(i686 x86_64)
url="http://www.bacula.org"
license=('AGPL3')
depends=('qt4')
source=("http://downloads.sourceforge.net/sourceforge/bacula/bacula-${pkgver}.tar.gz"
        "00-qmake4.patch")
md5sums=('43417bae0c221afb1f30a581c9e0f2fe'
         '9ac88867a9ad3a4fe0486a26d0cdb542')
sha1sums=('30b1eb2efb515138807163d046f675eaa29fad1c'
          '58a60e8af9b4735c564c7223c2bf0c25803927f3')

build() {
    pushd "${srcdir}/bacula-${pkgver}"

    patch -Np3 -i ../00-qmake4.patch || true

    true || ./configure                              \
    --enable-bat                             \
    --enable-batch-insert                    \
    --enable-client-only                     \
    --enable-ipv6                            \
    --enable-smartalloc                      \
    --prefix=/usr                            \
    --sbindir=/usr/bin                       \
    --sysconfdir=/etc/bacula                 \
    --with-openssl                           \
    --with-python                            \
    --with-scriptdir=/etc/bacula/scripts     \
    --with-systemd=/usr/lib/systemd/system/  \
    --with-tcp-wrappers                      \
    --with-x

    make
}

make_install() {
    pushd "${srcdir}/bacula-${pkgver}"
    
    make DESTDIR="$pkgdir" install
}

files_bacula-common() {
  files=(
    
  )
}

package_bacula-common() {
  backup=('etc/bacula/bconsole.conf'
          'etc/bacula/bacula-fd.conf'
  )

  install -d ${pkgdir}/usr/lib/
  install -m0755 ${srcdir}/bacula-${pkgver}/src/lib/.libs/libbac{,cfg}-${pkgver}.so ${pkgdir}/usr/lib/
  install -m0755 ${srcdir}/bacula-${pkgver}/src/findlib/.libs/libbacfind-${pkgver}.so ${pkgdir}/usr/lib/
}

package_bacula-console() {
  backup=('etc/bacula/bconsole.conf')
  depends=('bacula-common')

}

package_bacula-fd() {
  backup=('etc/bacula/bacula-fd.conf')
  depends=('bacula-common')

  install -D -m0644 ${srcdir}/bacula-${pkgver}/src/filed/bacula-fd.conf ${pkgdir}/etc/bacula/bacula-fd.conf
  install -D -m0755 ${srcdir}/bacula-${pkgver}/src/filed/.libs/bacula-fd ${pkgdir}/usr/bin/bacula-fd
  #gzip ${srcdir}/bacula-${pkgver}/manpages/bacula-fd.8
  install -D -m0644 ${srcdir}/bacula-${pkgver}/manpages/bacula-fd.8.gz ${pkgdir}/usr/share/man/man8/bacula-fd.8.gz
  install -D -m0644 ${srcdir}/bacula-${pkgver}/src/plugins/fd/.libs/bpipe-fd.so ${pkgdir}/usr/lib/bpipe-fd.so
  install -D -m0644 ${srcdir}/bacula-${pkgver}/platforms/systemd/bacula-fd.service ${pkgdir}/usr/lib/systemd/system/bacula-fd.service
}

package_bat() {
  backup=('etc/bacula/bat.conf')
  depends=('bacula-common')

  mkdir -p ${pkgdir}/{etc,usr/{bin,lib,share/{man/man1,applications,pixmaps}}}
  install -D -m0755 ${srcdir}/bacula-${pkgver}/src/qt-console/.libs/bat ${pkgdir}/usr/bin/bat
  install -D -m0644 ${srcdir}/bacula-${pkgver}/src/qt-console/bat.conf ${pkgdir}/etc
  install -D -m0644 ${srcdir}/bacula-${pkgver}/manpages/bat.1 ${pkgdir}/usr/share/man/man1/bat.1
  install -D -m0644 ${srcdir}/bacula-${pkgver}/scripts/bat.desktop ${pkgdir}/usr/share/applications/bat.desktop
  install -D -m0644 ${srcdir}/bacula-${pkgver}/src/qt-console/images/bat_icon.png ${pkgdir}/usr/share/pixmaps/bat_icon.png
}
