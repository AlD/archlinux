# Contributor: Daniel Albers <daniel@lbe.rs>

pkgbase=bacula
pkgname=('bacula-bat'
'bacula-console'
'bacula-fd'
'bacula-common'
)
pkgver=5.2.13
pkgrel=4
arch=(i686 x86_64)
url="http://www.bacula.org"
license=('AGPL3')
depends=('qt4')
source=("http://downloads.sourceforge.net/sourceforge/bacula/bacula-${pkgver}.tar.gz"
        "00-qmake4.patch")
md5sums=('43417bae0c221afb1f30a581c9e0f2fe'
         '9ac88867a9ad3a4fe0486a26d0cdb542')
sha1sums=('30b1eb2efb515138807163d046f675eaa29fad1c'
          '58a60e8af9b4735c564c7223c2bf0c25803927f3')

build() {
    pushd "${srcdir}/bacula-${pkgver}"

    patch -Np3 -i ../00-qmake4.patch || true

    true || ./configure                              \
    --enable-bat                             \
    --enable-batch-insert                    \
    --enable-client-only                     \
    --enable-ipv6                            \
    --enable-smartalloc                      \
    --prefix=/usr                            \
    --sbindir=/usr/bin                       \
    --sysconfdir=/etc/bacula                 \
    --with-openssl                           \
    --with-python                            \
    --with-scriptdir=/etc/bacula/scripts     \
    --with-systemd=/usr/lib/systemd/system/  \
    --with-tcp-wrappers                      \
    --with-x

    make
}

make_install() {
    pushd "${srcdir}/bacula-${pkgver}"
    
    make DESTDIR="$pkgdir" install
}

_files_bacula-common() {
  echo \
    ${pkgdir}/usr/lib/libbac{,cfg,find,py}-${pkgver}.so
}

_files_bacula-console() {
:
}

_files_bacula-fd() {
  echo \
    ${pkgdir}/etc/bacula/bacula-fd.conf \
    ${pkgdir}/usr/bin/bacula-fd \
    ${pkgdir}/usr/share/man/man8/bacula-fd.8.gz \
    ${pkgdir}/usr/lib/bpipe-fd.so
}

_files_bacula-bat() {
  echo \
    ${pkgdir}/usr/bin/bat \
    ${pkgdir}/etc/bacula/bat.conf \
    ${pkgdir}/usr/share/man/man1/bat.1.gz

    #${pkgdir}/usr/share/applications/bat.desktop \
    #${pkgdir}/usr/share/pixmaps/bat_icon.png
}

package_bacula-common() {
  backup=('etc/bacula/bconsole.conf'
          'etc/bacula/bacula-fd.conf'
  )

  make_install

  rm \
    $(_files_bacula-console) \
    $(_files_bacula-fd) \
    $(_files_bacula-bat)
}

package_bacula-console() {
  backup=('etc/bacula/bconsole.conf')
  depends=('bacula-common')

  make_install

  rm \
    $(_files_bacula-common) \
    $(_files_bacula-fd) \
    $(_files_bacula-bat)
}

package_bacula-fd() {
  backup=('etc/bacula/bacula-fd.conf')
  depends=('bacula-common')

  make_install

  rm \
    $(_files_bacula-console) \
    $(_files_bacula-common) \
    $(_files_bacula-bat)
}

package_bacula-bat() {
  backup=('etc/bacula/bat.conf')
  depends=('bacula-common')

  make_install

  rm \
    $(_files_bacula-console) \
    $(_files_bacula-fd) \
    $(_files_bacula-common)
}
